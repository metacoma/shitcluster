- hosts: all
  become: true
  vars:
    broken_dns_server: "169.254.25.10"

  tasks:
    - name: Get current resolvectl DNS configuration
      command: resolvectl dns
      register: resolvectl_dns
      changed_when: false

    - name: Restart systemd-resolved if broken DNS server is present
      systemd:
        name: systemd-resolved
        state: restarted
      when: broken_dns_server in resolvectl_dns.stdout

    - name: Get resolvectl DNS configuration after restart
      command: resolvectl dns
      register: resolvectl_dns_after
      changed_when: false

    - name: Fail if broken DNS server is still present
      fail:
        msg: >-
          Broken DNS server {{ broken_dns_server }} is still configured in resolvectl dns:
          {{ resolvectl_dns_after.stdout }}
      when: broken_dns_server in resolvectl_dns_after.stdout

